<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PnL Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #000000;
      color: #ffffff;
      overflow-x: hidden;
    }
    
    /* Starry background effect - EXACT COPY from React app */
    .starry-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(2px 2px at 20% 30%, #fff, transparent),
        radial-gradient(2px 2px at 60% 70%, #fff, transparent),
        radial-gradient(1px 1px at 50% 50%, #fff, transparent),
        radial-gradient(1px 1px at 80% 10%, #fff, transparent),
        radial-gradient(2px 2px at 90% 40%, #fff, transparent),
        radial-gradient(1px 1px at 33% 60%, #fff, transparent),
        radial-gradient(1px 1px at 55% 80%, #fff, transparent),
        radial-gradient(2px 2px at 10% 90%, #fff, transparent),
        radial-gradient(1px 1px at 70% 20%, #fff, transparent),
        radial-gradient(1px 1px at 40% 40%, #fff, transparent);
      background-size: 200% 200%;
      background-position: 0% 0%;
      animation: starryMove 60s linear infinite;
      opacity: 0.3;
      z-index: 0;
      pointer-events: none;
    }
    
    @keyframes starryMove {
      0% { background-position: 0% 0%; }
      100% { background-position: 100% 100%; }
    }
    
    /* Grid pattern overlay - EXACT COPY from React app */
    .grid-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      z-index: 0;
      pointer-events: none;
      opacity: 0.2;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #000000;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #1a1a1a;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #2a2a2a;
    }
  </style>
</head>
<body class="fixed inset-0 bg-black text-white overflow-hidden">
  <!-- Starry Background - EXACT COPY from React app -->
  <div class="starry-background"></div>
  <div class="grid-overlay"></div>
  
  <!-- Main Container -->
  <div class="relative z-10 h-full flex flex-col">
    <!-- Header - EXACT COPY from React app -->
    <header class="bg-black/80 backdrop-blur-sm border-b border-gray-900 sticky top-0 z-50">
      <div class="w-full px-6 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-8">
            <div class="flex items-center">
              <img 
                src="/image/goatlogo.png" 
                alt="GOAT TOOLS Logo" 
                class="h-10 w-auto object-contain"
              />
            </div>
            <nav class="flex gap-1">
              <!-- Launch Tab -->
              <a
                href="http://localhost:3000"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-gray-400 hover:text-white hover:bg-gray-900/50"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <span>Launch</span>
              </a>
              <!-- Terminal Tab -->
              <a
                href="http://localhost:3000"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-gray-400 hover:text-white hover:bg-gray-900/50"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <span>Terminal</span>
              </a>
              <!-- Warming Tab -->
              <a
                href="http://localhost:3000"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-gray-400 hover:text-white hover:bg-gray-900/50"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                </svg>
                <span>Warming</span>
              </a>
              <!-- PnL Tab (ACTIVE) -->
              <a
                href="/profit-loss"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 bg-gray-900 text-white"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span>PnL</span>
              </a>
              <!-- Settings Tab -->
              <a
                href="http://localhost:3000"
                class="px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 text-gray-400 hover:text-white hover:bg-gray-900/50"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span>Settings</span>
              </a>
            </nav>
          </div>
          <div class="flex items-center gap-4">
            <div class="relative">
              <input
                type="text"
                placeholder="Search tokens..."
                class="bg-gray-900/50 border border-gray-800 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-48"
              />
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto">
      <div class="max-w-7xl mx-auto p-6">
        <h1 class="text-3xl font-bold text-white mb-6">üìä Profit/Loss & Launch Analysis</h1>
        
        <!-- Stats Bar -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6" id="statsBar">
          <div class="bg-gray-900/50 backdrop-blur-sm border border-gray-800 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase mb-2">Cumulative P/L</div>
            <div class="text-2xl font-bold text-white" id="cumulativePL">0.0000 SOL</div>
          </div>
          <div class="bg-gray-900/50 backdrop-blur-sm border border-gray-800 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase mb-2">Total Runs</div>
            <div class="text-2xl font-bold text-white" id="totalRuns">0</div>
          </div>
          <div class="bg-gray-900/50 backdrop-blur-sm border border-gray-800 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase mb-2">Successful</div>
            <div class="text-2xl font-bold text-white" id="successfulRuns">0</div>
          </div>
          <div class="bg-gray-900/50 backdrop-blur-sm border border-gray-800 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase mb-2">Failed</div>
            <div class="text-2xl font-bold text-white" id="failedRuns">0</div>
          </div>
          <div class="bg-gray-900/50 backdrop-blur-sm border border-gray-800 rounded-lg p-4">
            <div class="text-xs text-gray-500 uppercase mb-2">Avg P/L</div>
            <div class="text-2xl font-bold text-white" id="avgPL">0.0000 SOL</div>
          </div>
        </div>
        
        <!-- Records Grid -->
        <div class="space-y-4" id="recordsGrid">
          <div class="text-center py-12 text-gray-500">Loading profit/loss data...</div>
        </div>
        
        <!-- Analysis Section -->
        <div class="mt-6 bg-gray-900/50 backdrop-blur-sm border border-gray-800 rounded-lg p-6" id="analysisSection" style="display: none;">
          <div class="text-xl font-bold text-white mb-4">üîç Launch Style Analysis</div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="patternGrid"></div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    async function loadData() {
      try {
        const response = await fetch('/api/profit-loss');
        const result = await response.json();
        
        if (!result.success) {
          document.getElementById('recordsGrid').innerHTML = '<div class="text-center py-12 text-gray-500">Error loading data</div>';
          return;
        }
        
        const data = result.data;
        const records = (data.records || []).reverse();
        
        updateStats(data, records);
        renderRecords(records);
        renderAnalysis(records);
        
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('recordsGrid').innerHTML = '<div class="text-center py-12 text-gray-500">Error loading data</div>';
      }
    }
    
    function updateStats(data, records) {
      const completed = records.filter(r => r.status === 'completed');
      const failed = records.filter(r => r.status === 'failed');
      const avgPL = completed.length > 0 
        ? completed.reduce((sum, r) => sum + r.profitLoss, 0) / completed.length 
        : 0;
      
      document.getElementById('cumulativePL').textContent = 
        `${data.cumulativeProfitLoss >= 0 ? '+' : ''}${data.cumulativeProfitLoss.toFixed(4)} SOL`;
      document.getElementById('cumulativePL').className = 
        `text-2xl font-bold ${data.cumulativeProfitLoss >= 0 ? 'text-green-400' : 'text-red-400'}`;
      
      document.getElementById('totalRuns').textContent = records.length;
      document.getElementById('successfulRuns').textContent = completed.length;
      document.getElementById('failedRuns').textContent = failed.length;
      document.getElementById('avgPL').textContent = `${avgPL >= 0 ? '+' : ''}${avgPL.toFixed(4)} SOL`;
      document.getElementById('avgPL').className = `text-2xl font-bold ${avgPL >= 0 ? 'text-green-400' : 'text-red-400'}`;
    }
    
    function renderRecords(records) {
      const grid = document.getElementById('recordsGrid');
      
      if (records.length === 0) {
        grid.innerHTML = `
          <div class="text-center py-12">
            <div class="text-5xl mb-4">üìä</div>
            <div class="text-gray-500">No records yet. Launch a token to start tracking!</div>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = records.map(record => {
        const profitLoss = record.profitLoss || 0;
        const isPositive = profitLoss >= 0;
        const settings = record.launchSettings || {};
        const date = new Date(record.timestamp).toLocaleString();
        
        return `
          <div class="bg-gray-900/50 backdrop-blur-sm border border-gray-800 rounded-lg p-6">
            <div class="flex items-start gap-6 mb-4">
              ${settings.tokenImageUrl ? `<img src="${settings.tokenImageUrl}" class="w-20 h-20 rounded-lg object-cover border border-gray-700" />` : ''}
              <div class="flex-1">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <h3 class="text-xl font-bold text-white">${record.tokenName || 'Unknown Token'}</h3>
                    <div class="text-sm text-gray-400">${record.tokenSymbol || 'N/A'}</div>
                  </div>
                  <div class="text-right">
                    <div class="text-2xl font-bold ${isPositive ? 'text-green-400' : 'text-red-400'}">
                      ${isPositive ? '+' : ''}${profitLoss.toFixed(4)} SOL
                    </div>
                    <span class="px-2 py-1 text-xs rounded ${
                      record.status === 'completed' ? 'bg-green-900/50 text-green-400' : 
                      record.status === 'failed' ? 'bg-red-900/50 text-red-400' : 
                      'bg-yellow-900/50 text-yellow-400'
                    }">${record.status.toUpperCase()}</span>
                  </div>
                </div>
                <div class="text-xs text-gray-500 mb-3">${date}</div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                  <div>
                    <div class="text-gray-500">Balance Before</div>
                    <div class="text-white font-medium">${record.balanceBefore.toFixed(4)} SOL</div>
                  </div>
                  <div>
                    <div class="text-gray-500">Balance After</div>
                    <div class="text-white font-medium">${record.balanceAfter.toFixed(4)} SOL</div>
                  </div>
                  <div>
                    <div class="text-gray-500">Bundle Wallets</div>
                    <div class="text-white font-medium">${settings.bundleWalletCount || 0}</div>
                  </div>
                  <div>
                    <div class="text-gray-500">Holder Wallets</div>
                    <div class="text-white font-medium">${settings.holderWalletCount || 0}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderAnalysis(records) {
      const completed = records.filter(r => r.status === 'completed');
      
      if (completed.length < 2) {
        document.getElementById('analysisSection').style.display = 'none';
        return;
      }
      
      document.getElementById('analysisSection').style.display = 'block';
      
      const patterns = analyzePatterns(completed);
      
      const patternGrid = document.getElementById('patternGrid');
      patternGrid.innerHTML = patterns.map(pattern => {
        const avgPL = pattern.avgProfitLoss;
        return `
          <div class="bg-black/50 border border-gray-700 rounded-lg p-4">
            <div class="text-sm font-medium text-white mb-2">${pattern.name}</div>
            <div class="flex items-center justify-between">
              <span class="text-xs text-gray-500">${pattern.count} launches</span>
              <span class="text-lg font-bold ${avgPL >= 0 ? 'text-green-400' : 'text-red-400'}">
                ${avgPL >= 0 ? '+' : ''}${avgPL.toFixed(4)} SOL
              </span>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function analyzePatterns(records) {
      const patterns = [];
      
      const warmed = records.filter(r => r.launchSettings?.usedWarmedWallets);
      const fresh = records.filter(r => !r.launchSettings?.usedWarmedWallets);
      
      if (warmed.length > 0) {
        patterns.push({
          name: 'üî• Warmed Wallets',
          count: warmed.length,
          avgProfitLoss: warmed.reduce((sum, r) => sum + r.profitLoss, 0) / warmed.length
        });
      }
      
      if (fresh.length > 0) {
        patterns.push({
          name: 'üÜï Fresh Wallets',
          count: fresh.length,
          avgProfitLoss: fresh.reduce((sum, r) => sum + r.profitLoss, 0) / fresh.length
        });
      }
      
      return patterns.sort((a, b) => b.count - a.count);
    }
    
    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>
